<!DOCTYPE html>
<html>
    <head>
        <meta name= "viewport" content="width=device-width, initial-scale = 1.0">
        <title>ManageLib | Calendar</title>
        <link rel="stylesheet" href="/calendarStyle.css">
        <link rel="stylesheet" href="/navbar.css">
    </head>
    <ul class="topnav">
        <nav>
            <li id="logo">
                <a href="/" class="logo"><img src = "/images/logo.png" height= 60></a>
            </li>
            
            <li id="home">
                <a href="/" class="tabs">Home</a>
            </li>
            
            <li id="events" class="tabs">
                <a href="/events" class="tabs">Events</a>
            </li>

            <li id="calendar" class="tabs">
                <a href="/calendar" class="tabs">Calendar</a>
            </li>    

            <% if (user) { %>
                <li class="greeting">Welcome, <%= user.email %></li>
                <button class="logout" onclick="window.location.href='/logout'">Logout</button>
            <% } else { %>
                <button class="signup" onclick="window.location.href='/signup'">Sign Up</button>
                <button class="login" onclick="window.location.href='/login'">Log In</button>
            <% } %>
        </nav>
    </ul>

    <div class = "Calendar">
        <table class="calendar">
            <thead>
                <tr>
                    <th>Sun</th>
                    <th>Mon</th>
                    <th>Tue</th>
                    <th>Wed</th>
                    <th>Thu</th>
                    <th>Fri</th>
                    <th>Sat</th>
                </tr>
            </thead>
            <tbody id="calendar-body">
                    <div id="eventMenu" class="menu">
                        <div class="menu-content">
                            <span class="close" onclick="closeMenu()">&times;</span>
                            <div class="event-information">
                                <h1>Events</h1>
                                <div id="currentEvent">
                                    <b>Events Scheduled: </b>
                                </div>
                            </div>
                            <div class = "addEvent">
                                <h2>Add Event:</h2>
                                <label for="eventTitle">Title: </label>
                                <input type="text" id="eventTitle"><br>

                                <label for="eventDescription">Description: </label>
                                <input type="text" id="eventDescription"><br>

                                <label for="eventDate">Date: </label>
                                <input type="text" id="eventDate" readonly><br>

                                <label for="eventTime">Time: </label>
                                <input type="text" id="eventTime"><br>

                                <button onclick="saveEvent()">Save Event</button>
                            </div>
                        </div>
                    </div>
            </tbody>
        </table>
    </div>

    <script>

        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const currentDate = new Date();
        const eventsThisMonth = [];

        document.addEventListener("DOMContentLoaded", () => {
            const calendarBody = document.getElementById("calendar-body");
            const eventDateInput = document.getElementById("eventDate");
            const eventTitleInput = document.getElementById("eventTitle");
            const eventTimeInput = document.getElementById("eventTime"); 
            const eventDescriptionInput = document.getElementById("eventDescription");
            const currentEventDisplay = document.getElementById("currentEvent");
            const eventMenu = document.getElementById("eventMenu");
            
            let events = {};
            let descriptions = {};
            let times = {};


            '<% events.forEach(event => { %>'
            if('<%=event.date.toDateString().substring(4,7)%>' == monthNames[currentDate.getMonth()] && '<%=event.date.toDateString().substring(11,15)%>' == currentDate.getFullYear()) {
                var month = new Date(Date.parse('<%=event.date.toDateString().substring(4,7)%>'+"1, 2024")).getMonth()+1;
                var day = '<%=event.date.toDateString().substring(8,10)%>'
                var year = '<%=event.date.toDateString().substring(11,15)%>'
                let eventKey = `${year}-${month}-${day}`;
                events[eventKey] = '<%=event.title%>';
                descriptions[eventKey] = '<%=event.description%>';
                times[eventKey] = '<%=event.time%>';
                console.log(month);
            }
            '<% }) %>'
            
            function generateCalendar(year, month) {
                calendarBody.innerHTML = "";
                const date = new Date(year, month - 1, 1);
                const daysInMonth = new Date(year, month, 0).getDate();
                const firstDay = date.getDay();

                let row = document.createElement("tr");
                for (let i = 0; i < firstDay; i++) {
                    let cell = document.createElement("td");
                    row.appendChild(cell);
                }

                for (let day = 1; day <= daysInMonth; day++) {
                    if (row.children.length === 7) {
                        calendarBody.appendChild(row);
                        row = document.createElement("tr");
                    }
                    let cell = document.createElement("td");
                    cell.innerText = day;
                    cell.onclick = () => openMenu(year, month, day);
                    const eventKey = `${year}-${month}-${day}`;
                    if (events[eventKey]) {
                        const ribbon = document.createElement("div");
                        ribbon.className = "ribbon";
                        ribbon.innerText = events[eventKey];
                        cell.appendChild(ribbon);
                    }
                    row.appendChild(cell);
                }

                while (row.children.length < 7) {
                    let cell = document.createElement("td");
                    row.appendChild(cell);
                }
                calendarBody.appendChild(row);
            }

            function openMenu(year, month, day) {
                const eventKey = `${year}-${month}-${day}`;
                eventMenu.style.display = "block";
                eventDateInput.value = eventKey;

                if (events[eventKey]) {
                    currentEventDisplay.innerText = `${events[eventKey]} at ${times[eventKey]} \n Description: ${descriptions[eventKey]}`;
                } else {
                    currentEventDisplay.innerText = "No events scheduled on this day.";
                }
            }

            function closeMenu() {
                eventMenu.style.display = "none";
                eventTitleInput.value = "";
                eventTimeInput.value = "";
                eventDescriptionInput.value = "";
            }

            function saveEvent() {
                const date = eventDateInput.value;
                const title = eventTitleInput.value;
                const description = eventDescriptionInput.value;
                const time = eventTimeInput.value;

                if (title && description && time) {
                    events[date] = title;
                    descriptions[date] = description;
                    times[date] = time;
                    closeMenu();
                    generateCalendar(new Date().getFullYear(), new Date().getMonth() + 1);
                } else {
                    alert("One or more lines is empty!");
                }
            }

            generateCalendar(new Date().getFullYear(), new Date().getMonth() + 1);

            window.closeMenu = closeMenu;
            window.saveEvent = saveEvent;
        });
    </script>
</html>